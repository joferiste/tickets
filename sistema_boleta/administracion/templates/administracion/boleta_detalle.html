<!-- administracion/templates/administracion/boleta_detalle.html -->
{% extends "core/base.html" %}
{% load static %}

{% block title %} Detalle del Correo {% endblock %}

{% block page_title %} Detalle del Correo {% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'administracion/css/boleta_detalle_style.css' %}">
<script src=" {% static 'administracion/js/boleta_detalle.js' %}"></script> 

<div class="boleta_detalle_container">
    <div class="info-section">  
        <button class="info-button" onclick="openInfoModal()">¿Cómo funciona esta sección?</button>
        <h2>Detalle del Mensaje</h2>
        <table class="info-table">
            <tr><th>Remitente</th><td>{{ boleta.remitente }}</td></tr>
            <tr><th>Asunto</th><td>{{ boleta.asunto }}</td></tr>
            <tr><th>Mensaje</th><td>{{ boleta.mensaje }}</td></tr>
            <tr><th>Fecha</th><td>{{ boleta.fecha_recepcion }}</td></tr>
            <tr><th>Estado validación</th><td>{{ boleta.get_estado_validacion_display }}</li>
            <tr><th>Motivo</th><td>{{ boleta.comentarios_validacion }}</li>
        </table> 

        <div class="acciones">
            <a href="{% url 'administracion:boletas_sandbox' %}" class="btn btn-secondary"> Regresar</a>
            <a href="{% url 'administracion:boleta_revisar' boleta.id %}" class="btn btn-primary">Confirmar</a>
            
        </div>
    </div>  

    <div class="image-section">
        <h2> Boleta </h2>
        {% if boleta.imagen %}
                <img src="{{ boleta.imagen.url }}" alt="Boleta" class="detalle-img">
        {% else %}
            <p class="no-img">Sin imagen adjunta</p> 
        {% endif %} 
            <button id="OpenImageModal" class="btn-primary emp-btn"> [+ Ver imagen] </button>
    </div> 

    <!-- Modal de informacion -->
        <div id="infoModal" class="info-modal">
            <div class="info-modal-content">
                <span class="close" onclick="closeInfoModal()">&times;</span>
                <h2>Fases del procesamiento de boletas</h2>
                        <strong>Fase 1 - Validación Técnica (Sandbox):</strong>
                        <p>El sistema recibe automáticamente correos con imágenes adjuntas de boletas. En esta etapa se realiza una validación inicial del contenido, comprobando que el correo proviene de un remitente conocido y que la imagen adjunta cumple con los requisitos técnicos.</p>
            </div>
        </div>

    <!--Modal para confirmacion de eliminacion-->
<div id="modalConfirmacion" class="modal hidden">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h3 id="mensajeConfirmacion">¿Estás seguro?</h3>
        <form id="formEliminar" method="POST">
            {% csrf_token %}
            <button type="submit" class="btns btn-conf-delete">Sí, eliminar</button>
            <button type="button" class="btns btn-conf-cancel" onclick="cerrarModal()">Cancelar</button>
        </form>
    </div>
</div>  

   <!-- Modal para visor de imagen mejorado -->
<div id="imagenModal" class="modal hidden">      
    <div class="modal-content-viewer">
        <!-- Header del modal con botón de cerrar -->
        <div class="modal-header-viewer">
            <h3>Vista de Boleta</h3>
            <button class="close-btn" id="closeModal">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Contenedor de imagen con scroll -->
        <div class="image-viewport" id="imageViewport">
            <div class="image-container" id="imageContainer">
                <img id="boletaImage" src="{{ boleta.imagen.url }}" alt="Boleta" draggable="false" />
            </div>
        </div>

        <!-- Controles mejorados -->
        <div class="controls-viewer">
            <div class="controls-group">
                <button class="control-btn" id="rotateLeft" title="Rotar izquierda">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                    </svg>
                    <span>Rotar </span>
                </button>
                
                <button class="control-btn" id="rotateRight" title="Rotar derecha">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    <span>Rotar </span>
                </button>
            </div>

            <div class="controls-group">
                <button class="control-btn" id="zoomOut" title="Alejar (Ctrl + -)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
                <button class="control-btn" id="zoomIn" title="Acercar (Ctrl + +)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
            </div>

            <div class="controls-group">
                <button class="control-btn" id="fitToScreen" title="Ajustar a pantalla">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <polyline points="9 21 3 21 3 15"></polyline>
                        <line x1="21" y1="3" x2="14" y2="10"></line>
                        <line x1="3" y1="21" x2="10" y2="14"></line>
                    </svg>
                    <span>Ajustar</span>
                </button>
                
                <button class="control-btn" id="resetImage" title="Restaurar (Ctrl + 0)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                    <span>Restaurar</span>
                </button>
            </div>
        </div>

        <!-- Indicadores -->
        <div class="viewer-indicators">
            <div class="indicator" id="dragIndicator">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"></path>
                </svg>
                <span>Arrastra para mover</span>
            </div>
            <div class="indicator" id="wheelIndicator">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="2" width="6" height="20" rx="3"></rect>
                    <path d="M12 6v4"></path>
                </svg>
                <span>Rueda del mouse para zoom</span>
            </div>
        </div>
    </div>
</div>
    <!-- modal para bloqueo por duplicacion de procesamiento de pago -->
    {% if boleta.estado_validacion == "procesada" %}
        <div id="modalBlock" class="modal-block hidden">
            <div class="modal-bloqueo">
                <h1 class="title-grand">
                    ESTA BOLETA YA HA SIDO PROCESADA
                </h1>
                <h2>
                    Fecha y hora de procesamiento:
                </h2>
                <h3>
                    {{ boleta.fecha_procesada|date:"d/m/Y H:i" }}
                </h3>
                <a href="{% url 'administracion:boletas_sandbox' %}" class="btn-sandbox">
                    Volver a la bandeja de entrada
                </a>
            </div>
        </div>
    {% endif %}


</div>
{% endblock %}