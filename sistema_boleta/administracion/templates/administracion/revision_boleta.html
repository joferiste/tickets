{% extends 'core/base.html' %}
{% load static %}
{% load boletas_extras %}

{% block title %} Administraci√≥n de boleta {% endblock %}

{% block page_title %} Ingreso de boleta {% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'administracion/css/boleta_style.css' %}">
<script src="{% static 'administracion/js/boleta_scripts.js' %}"> </script>

<div class="page-container">
    <div class="content-wrapper">
        
        <!-- Secci√≥n principal dividida en dos columnas -->
        <div class="main-sections">
            
            <!-- Columna izquierda: Datos del cliente -->
            <div class="left-column">
                <div class="section-card client-data">
                    <div class="section-header">
                        <h3>Datos obtenidos desde la relaci√≥n correo - cliente</h3>
                    </div>
                    <div class="section-content">
                        <div class="data-grid">
                            <div class="data-row">
                                <span class="label">Negocio:</span>
                                <span class="value">{{ negocio.nombre }}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Responsable:</span>
                                <span class="value">{{ usuario }}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Local(es) arrendado(s):</span>
                                <span class="value">{{ nombre_local }}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Cuota mensual (Contrato):</span>
                                <span class="value amount-base">Q.{{ contexto_cuota.cuota_original|formato_q }}</span>
                            </div>
                            
                            <!-- Faltante previo -->
                            {% if contexto_cuota and contexto_cuota.tiene_faltante_previo %}
                                <div class="data-row highlight-warning">
                                    <span class="label">Pago pendiente de completar:</span>
                                    <div class="pending-details">
                                        <div class="pending-item">
                                            <span class="pending-label">Per√≠odo:</span>
                                            <span class="pending-value">{{ contexto_cuota.periodo_pendiente|periodo_legible }}</span>
                                        </div>
                                        <div class="pending-item">
                                            <span class="pending-label">Monto ya pagado:</span>
                                            <span class="pending-value">Q.{{ contexto_cuota.monto_ya_pagado|formato_q }}</span>
                                        </div>
                                        <div class="pending-item">
                                            <span class="pending-label">Faltante por pagar:</span>
                                            <span class="pending-value amount-danger">Q.{{ contexto_cuota.faltante_previo|formato_q }}</span>
                                        </div>
                                        <div class="pending-item">
                                            <span class="pending-label">Total requerido:</span>
                                            <span class="pending-value">Q.{{ contexto_cuota.monto_total_requerido|formato_q }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Ajustes por mora -->
                            {% if contexto_cuota and contexto_cuota.tiene_ajustes and contexto_cuota.tipo == 'mora' %}
                                <div class="data-row highlight-warning">
                                    <span class="label">Cuota mensual (Ajustada):</span>
                                    <div class="adjusted-amount">
                                        <span class="value amount-adjusted">Q.{{ contexto_cuota.cuota_ajustada|formato_q }}</span>
                                        <span class="adjustment-note">(+Q.{{ contexto_cuota.diferencia|formato_q }} por {{ contexto_cuota.tipo }})</span>
                                    </div>
                                </div>
                                {% if contexto_cuota.mensaje_contexto %}
                                    <div class="context-message warning">
                                        {{ contexto_cuota.mensaje_contexto }}
                                    </div>
                                {% endif %}
                            {% endif %}

                            <!-- Excedentes en espera -->
                            {% if contexto_cuota and contexto_cuota.tiene_ajustes and contexto_cuota.tipo == 'excedente_espera' %}
                                <div class="data-row highlight-info">
                                    <span class="label">Cuota mensual (Ajustada):</span>
                                    <div class="adjusted-amount">
                                        <span class="value amount-success">Q.{{ contexto_cuota.cuota_ajustada|formato_q }}</span>
                                        <span class="adjustment-note">(-Q.{{ contexto_cuota.diferencia|formato_q }} por excedentes en espera)</span>
                                    </div>
                                </div>
                                <div class="data-row">
                                    <span class="label">Excedentes en espera:</span>
                                    <span class="value amount-info">Q.{{ contexto_cuota.excedentes_en_espera|formato_q }}</span>
                                </div>
                                {% if contexto_cuota.mensaje_contexto %}
                                    <div class="context-message info">
                                        {{ contexto_cuota.mensaje_contexto }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div class="actions-section">
                    <div class="actions-grid">
                        <a href="{% url 'administracion:boleta_detalle' boleta.id %}" class="btn btn-secondary">
                            <span class="btn-icon">‚Üê</span>
                            <span class="btn-text">Regresar</span>
                        </a>
                        <button class="btn btn-primary" onclick="openModal('modal-{{ boleta.id }}')">
                            <span class="btn-icon">üìã</span>
                            <span class="btn-text">Completar datos desde imagen</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Columna derecha: Datos del correo + Contexto administrativo -->
            <div class="right-column">
                <!-- Datos del correo -->
                <div class="section-card email-data">
                    <div class="section-header">
                        <h3>Datos obtenidos desde el correo</h3>
                    </div>
                    <div class="section-content">
                        <div class="data-grid">
                            <div class="data-row">
                                <span class="label">Remitente:</span>
                                <span class="value">{{ boleta.remitente }}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Fecha de recepci√≥n del correo:</span>
                                <span class="value">{{ boleta.fecha_recepcion }}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Asunto:</span>
                                <span class="value">{{ boleta.asunto|default:"(Sin asunto)" }}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Mensaje:</span>
                                <span class="value message-content">{{ boleta.mensaje|default:"(Sin mensaje)" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contexto administrativo -->
                {% if contexto_cuota and contexto_cuota.contexto_admin %}
                <div class="section-card admin-context {{ contexto_cuota.contexto_admin.class_css }}">
                    <div class="section-header">
                        <h3>Contexto para el Administrador</h3>
                    </div>
                    <div class="section-content">
                        <div class="context-title">
                            <strong>{{ contexto_cuota.contexto_admin.titulo }}</strong> 
                        </div>
                        {% if contexto_cuota.contexto_admin.mensaje %}
                            <div class="context-description">
                                {{ contexto_cuota.contexto_admin.mensaje }}
                            </div>
                        {% endif %}
                        {% if contexto_cuota.contexto_admin.detalles %}
                            <div class="context-details">
                                {% for detalle in contexto_cuota.contexto_admin.detalles %}
                                    <div class="detail-item">{{ detalle }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal (permanece igual) -->
<div id="boletaModal" class="modal hidden">
    <div class="modal-inner"> 
    <!-- Imagen y controles -->
        <div class="modal-image">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="image-wrapper">
                <img id="modalImage" src="{{ boleta.imagen.url }}" alt="Boleta" />
            </div>
            <div class="controls">
                <button onclick="rotateLeft()">‚ü≤ Rotar</button>
                <button onclick="rotateRight()">‚ü≥ Rotar</button>
                <button onclick="zoomIn()"> + Acercar</button>
                <button onclick="zoomOut()"> - Alejar</button>
                <button onclick="resetImage()">‚Ü∫ Restaurar</button>
            </div>
        </div>

        <!-- Formulario -->
        <div class="modal-form">
            <h2>Procesar Boleta</h2>
            <form id="procesarBoletaForm" method="POST" action="{% url 'administracion:procesar_boleta' boleta.id %}">
                {% csrf_token %}
                {{ form.as_p}}

            <label>Banco y n√∫mero de cuenta</label>
                <select name="banco" required>
                <option value="">-- Selecciona --</option>
                    {% for banco in bancos %}
                        <option value="{{ banco.id }}">{{ banco.nombre }} - {{ banco.numero_cuenta }}</option>
                    {% endfor %}
                </select>

                <label>N√∫mero de Boleta</label>
                <input type="text" name="numeroBoleta" id="numeroBoleta" inputmode="numeric" autocomplete="off"
                            pattern="^\d{4,20}$" title="Ingrese s√≥lo d√≠gitos (4 a 10 caracteres)" placeholder="Ingrese s√≥lo d√≠gitos (4 a 10 caracteres)" required>

                <label for="fechaDeposito">Fecha de dep√≥sito</label>
                <input type="date" name="fechaDeposito" id="fechaDeposito" max="{{ hoy|date:'Y-m-d' }}" required>

                <label>Monto</label>
                <input type="text" name="monto" id="monto" inputmode="decimal" autocomplete="off" pattern="^\d+([.,]\d{1,2})?$"
                            title="Ejemplos validos: 200, 214.5, 214.50" placeholder="Ejemplos v√°lidos: 200, 214.5, 214.50" required>

                <label>Tipo de Pago</label>
                <select name="tipoPago" required>
                <option value="">-- Selecciona --</option>
                    {% for tipo in tipos_pago %}
                        <option value="{{ tipo.idTipoPago }}">    
                            {{ tipo.nombre }}
                        </option>
                    {% endfor %}
                </select>
                <div class="btn-form">
                    <button id="btn-procesar" type="submit" class="btn-procesar">Procesar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="resultadoModal" class="modal-resultado hidden-1">
    <div class="modal-resultado-inner">
        <div class="modal-resultado-content">
            <!-- modal dinamico basado en el resultado -->
            <div id="resultado-exitoso" class="resultado-section hidden-1">
                <div class="resultado-icon success">
                    ‚úÖ
                </div>
                <h2 class="resultado-title success"> ¬°Pago procesado exitosamente! </h2>
                <div class="resultado-mensaje" id="mensaje-exitoso">
                    <!--mensaje dinamico aqui-->
                </div>
                <div class="resultado-actions">
                <button id="verTransaccionBtn" class="btn-resultado primary">
                    Ver Transacci√≥n
                </button>
                <button onclick="closeResultadoModal()" class="btn-resultado secondary">
                    Cerrar
                </button>
            </div>
            </div>

            <div id="resultado-pendiente" class="resultado-section hidden-1">
                <div class="resultado-icon warning">
                    ‚ö†Ô∏è
                </div>
                <h2 class="resultado-title warning"> Pago procesado - Acci√≥n requerida</h2>
                <div class="resultado-mensaje" id="mensaje-pendiente">
                    <!--mensaje dinamico aqui-->
                </div>
                <div class="resultado-actions">
                <button id="verTransaccionBtn" class="btn-resultado primary">
                    Ver Transacci√≥n
                </button>
                <button onclick="closeResultadoModal()" class="btn-resultado secondary">
                    Cerrar 
                </button>
            </div>
            </div>

            <div id="resultado-error" class="resultado-section hidden-1">
                <div class="resultado-icon error">
                    ‚ùå
                </div>
                <h2 class="resultado-title error"> Error en el procesamiento</h2>
                <div class="resultado-mensaje" id="mensaje-error">
                    <!--mensaje dinamico aqui-->
                </div>
                <div class="resultado-actions">
                    <a href="{% url 'administracion:boletas_sandbox' %}" class="btn-resultado primary">
                    Volver a la bandeja de entrada
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}